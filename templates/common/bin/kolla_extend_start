#!/bin/bash

GLANCE_PORT=${GLANCE_PORT:-9292}
GLOBAL_CONF=${GLOBAL_CONF:-/etc/glance/glance.conf.d/01-config.conf}
URISCHEME=${URISCHEME:-http}

function set_worker_self_reference_url {
cat <<EOF > "${GLOBAL_CONF}"
[DEFAULT]
worker_self_reference_url="${URISCHEME,,}://$(hostname).${GLANCE_DOMAIN}:${GLANCE_PORT}"
EOF

}

# Temporary workaround until the glance-api image in tcib is fixed
# Other services like Cinder and manila already provides both the
# DocumentRoot path and the wsgi script in the right location.
# TODO: Remove L19-L20 when tcib is fixed.
mkdir -p /var/www/cgi-bin/glance
cp /usr/bin/glance-wsgi-api /var/www/cgi-bin/glance/glance-wsgi

if [[ -n "${GLANCE_DOMAIN}" ]]; then
    set_worker_self_reference_url
fi
